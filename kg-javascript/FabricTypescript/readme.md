## Parcel Fabric Editing with Typescript

### Demonstrates using the Parcel Fabric Server and Version Management Server REST APIs in a Typescript application.

#### Resources
[Get started with TypeScript in an ArcGIS API for JavaScript application](https://developers.arcgis.com/javascript/latest/guide/typescript-setup/)

[Overview of Parcel Fabric Services](https://developers.arcgis.com/rest/services-reference/overview-of-parcel-fabric-sevices.htm)

[Overview of Version Management Services](https://developers.arcgis.com/rest/services-reference/version-management-service.htm)

[Using JavaScript Promises](https://developers.arcgis.com/javascript/latest/guide/programming-patterns/#promises)

### Overview
This sample application makes significant use of the [esriRequest](https://developers.arcgis.com/javascript/latest/api-reference/esri-request.html) function to fetch JSON objects from the server.  The ParcelFabric.ts class and the VersionManagement.ts classes help structure the server's responses into manageable objects.  Because esriRequest function returns a promise, these classes can help organize the flow of asynchronous server calls.  This organization is useful in situations where a specific call must be executed before moving on to the next (i.e. starting the edit session).

### The Version Management Service:
#### Access an edit version's name and GUID properties in a Version object.

```javascript
let vms = new VersionManagementService(baseUrl);

vms.setVersion("gis.myVersion1")
    .then((resp) => {
        console.log(resp);
    })
    .catch((err) => {
        console.log(err);
    });
    
console.log( vms.getVersion() );

```
output:
```
true
{versionName: "gis.myVersion1", versionGuid: "{AF9EB1AD-2AA6-4533-A194-0E126E741EC0}"}
```

#### Start and stop the edit session:
With the VersionManagement object (vms) created, it can be passed into the ParcelFabric object and used to open up the version for editing.  In this case, the ```startReading``` function must be called on the server.  This call will generate locks that prevent others from editing, reconciling and posting from that version.  This can be accomplished using the ``` toggleEditSession('start/stop')``` function.  This function will also generate and set the sessionId GUID value on the object.

```javascript
let vms = new VersionManagementService(baseUrl);

vms.setVersion("gis.myVersion1")
    .then((resp) => {
        vms.toggleEditSession("startReading")
    })
    .then(() => {
        // do some work that requires an edit session...
    })
    .then(() => {
        vms.toggleEditSession("stopReading")
    })
```

### Parcel Fabric Service
#### Create a new legal record (applyEdits)
Create a new record by passing in necessary parameters to the Records feature service's ```applyEdits``` method.  
- The sessionId and version name values are supplied by the VMS object.
- The new globalid value is generated by using a method on the VMS object.
- The new objectid value is supplied by a private method that queries the server for a new objectid value.
The sample application provides a form for entering the new record's name.  The form can be customized to include other fields.

```url/layer_id/reserveObjectIDs```.
```javascript
let params = {
      f: "json",
      rollbackOnFailure: true,
      sessionId: sessionId,
      useGlobalIds: true,
      gdbVersion: this._versionName,
      returnEditMoment: true,
      returnServiceEditsOption: "originalAndCurrentFeatures",
      usePreviousEditMoment: false,
      edits: `[{"id":1,"adds":[{"attributes":{"objectid":${objectId},"name":"${recordName}"..."globalid":"{${globalid}}"...
```

#### Merge parcels
As with most Parcel Fabric Server functions, the Parcel Fabric REST API is simply sending valid values to the server.  In this sample, the selected features in the map are passed into the mergeParcels function where their globalId and layerId values are parsed and turned into a JSON string.
```javascript
selectedFeatures.forEach((item) => {
    let parentParcel = { "id": item.attributes.globalid, "layerId": String(item.layer.layerId) };
    parentParcels.push(parentParcel);
});
let parentParcelsStr = JSON.stringify(parentParcels);
let mergeOptions = {
      "f": "json",
      "gdbVersion": versionName,
      "sessionId": sessionId,
      "parentParcels": parentParcelsStr,
      "record": activeRecordGuid,
      "mergeInto": "{00000000-0000-0000-0000-000000000000}",
      "moment": moment,
      "targetParcelType": selectedFeatures[0].layer.layerId,
      "defaultAreaUnit": 109405,
      "attributeOverrides": propertySet,
    }
```
